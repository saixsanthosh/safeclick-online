<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>PROJECT KRS â€“ Dashboard</title>
<link rel="stylesheet" href="style.css">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- jsPDF for PDF exports -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body onload="initApp()">

<header>
    <h1 id="projectTitle">PROJECT KRS</h1>
    <div class="top-controls">
        <button id="themeToggle" onclick="toggleTheme()">Toggle Theme</button>
    </div>
</header>

<div class="container">
    <div class="left-panel">
        <h2>ðŸ“¦ Orders Collected <span id="newBadge" class="badge" style="display:none">NEW</span></h2>

        <table id="ordersTable">
            <thead>
            <tr>
                <th>Order ID</th>
                <th>Name</th>
                <th>Phone</th>
                <th>Selfie</th>
                <th>View</th>
            </tr>
            </thead>
            <tbody id="ordersBody"></tbody>
        </table>

        <div class="log-feed" id="logFeed"></div>

        <div class="details-box" id="detailsBox" style="display:none;">
            <h2>ðŸ“„ Order Details</h2>
            <div id="details"></div>
            <img id="selfieImg" width="300" style="cursor:pointer" onclick="openModal()">
            <div style="margin-top:10px">
                <button onclick="exportPDF()">Export PDF</button>
            </div>
        </div>
    </div>

    <div class="right-panel">
        <div id="map" style="height: 45%; border-radius:8px;"></div>
        <h3>Live Hacker Code</h3>
        <div id="codeBox" class="codeBox"></div>
    </div>
</div>

<!-- selfie modal -->
<div id="modal" class="modal" onclick="closeModal()">
    <img id="modalImg" class="modal-content">
</div>

<!-- audio alert -->
<audio id="alertSound">
  <source src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" type="audio/ogg">
</audio>

<script>
// ---- Configuration ----
const BACKEND = "http://127.0.0.1:8000";
let lastOrderId = -1;
let map, markers = [];

// ---- Initialize app ----
function initApp() {
    initMap();
    startCodeAnimation();
    pollOrders();
    setInterval(pollOrders, 3000);
}

// ---- Polling for orders ----
async function pollOrders() {
    try {
        const res = await fetch(BACKEND + "/orders");
        const payload = await res.json();
        const orders = payload.orders || [];
        updateOrdersTable(orders);

        // log
        appendLog(`[${new Date().toLocaleTimeString()}] polled ${orders.length} orders`);
    } catch (e) {
        appendLog("[ERROR] cannot reach backend");
        console.error(e);
    }
}

// ---- Update table and check new ----
function updateOrdersTable(orders) {
    const tbody = document.getElementById("ordersBody");
    tbody.innerHTML = "";

    orders.forEach(o => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${o.order_id}</td>
            <td>${escapeHtml(o.name)}</td>
            <td>${escapeHtml(o.phone)}</td>
            <td>${o.selfie_path ? `<img src="${BACKEND + o.selfie_path}" width="50">` : ""}</td>
            <td><button onclick="viewDetails(${o.id})">View</button></td>
        `;
        tbody.appendChild(tr);
    });

    // detect newly arrived
    if (orders.length > 0) {
        const newest = orders[0].id;
        if (lastOrderId === -1) lastOrderId = newest; // init
        if (newest > lastOrderId) {
            lastOrderId = newest;
            newOrderAlert();
        }
    }
}

// ---- New order alert visual + sound + log ----
function newOrderAlert() {
    const badge = document.getElementById("newBadge");
    badge.style.display = "inline-block";
    document.getElementById("alertSound").play().catch(()=>{});
    appendLog("[ALERT] New order received!");
    setTimeout(()=> badge.style.display = "none", 5000);
}

// ---- View details (request single order endpoint) ----
async function viewDetails(id) {
    const res = await fetch(BACKEND + "/order/" + id);
    const o = await res.json();
    if (o.error) return appendLog("[ERROR] order not found");

    document.getElementById("detailsBox").style.display = "block";
    document.getElementById("details").innerHTML = `
        <b>Name:</b> ${escapeHtml(o.name)}<br>
        <b>Email:</b> ${escapeHtml(o.email)}<br>
        <b>Phone:</b> ${escapeHtml(o.phone)}<br>
        <b>Address:</b> ${escapeHtml(o.address)}<br>
        <b>City:</b> ${escapeHtml(o.city)} <b>Pincode:</b> ${escapeHtml(o.pincode)}<br>
        <b>Items:</b> ${escapeHtml(o.items)}<br>
        <b>Total:</b> â‚¹${escapeHtml(o.total)}<br>
        <b>IP:</b> ${escapeHtml(o.ip)}<br>
        <b>Device:</b> ${escapeHtml(o.device)}<br>
        <b>Time:</b> ${escapeHtml(o.timestamp)}<br>
        <div id="flags"></div>
    `;
    if (o.selfie_path) {
        document.getElementById("selfieImg").src = BACKEND + o.selfie_path;
        document.getElementById("modalImg").src = BACKEND + o.selfie_path;
    } else {
        document.getElementById("selfieImg").src = "";
        document.getElementById("modalImg").src = "";
    }

    // add marker on map via geolocation by IP
    addMarkerFromIP(o.ip, o);

    // analyze suspicious signals
    const flags = analyzeSuspicious(o);
    document.getElementById("flags").innerHTML = flags.length ? "<b>Flags:</b> " + flags.join(", ") : "<b>Flags:</b> None";
    flags.forEach(f => appendLog("[FLAG] " + f));
}

// ---- Simple suspicious detector (heuristics) ----
function analyzeSuspicious(o) {
    const flags = [];
    // email suspicious if free domain or nonsense
    const email = (o.email||"").toLowerCase();
    if (!email.includes("@") || email.split("@")[1].length < 4) flags.push("Invalid email");
    const freeDomains = ["gmail.com","yahoo.com","hotmail.com","rediffmail.com"];
    if (freeDomains.includes(email.split("@")[1])) flags.push("Free email domain");
    // phone length
    if (!/^\d{10,}$/.test(o.phone)) flags.push("Phone number unusual");
    // pincode mismatch simple (non-digit or short)
    if (!/^\d{5,6}$/.test(o.pincode)) flags.push("Pincode unusual");
    // total extremely low (scam bait)
    const totalNum = parseFloat(o.total || "0");
    if (totalNum < 10) flags.push("Suspiciously low price");
    return flags;
}

// ---- Map setup ----
function initMap() {
    try {
        map = L.map('map').setView([20.5937,78.9629], 3);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18
        }).addTo(map);
    } catch(e) {
        appendLog("[WARN] Leaflet map failed to initialize");
    }
}

async function addMarkerFromIP(ip, order) {
    if (!ip || ip === "127.0.0.1" || ip === "localhost") return;
    try {
        // free geo API
        const res = await fetch(`https://ipapi.co/${ip}/json/`);
        const geo = await res.json();
        if (geo && geo.latitude && geo.longitude) {
            const m = L.circleMarker([geo.latitude, geo.longitude], {
                radius: 8,
                color: "#00ff9d",
                fillColor: "#00ff9d",
                fillOpacity: 0.8
            }).addTo(map).bindPopup(`<b>${escapeHtml(order.name)}</b><br>${escapeHtml(order.city)} (${escapeHtml(ip)})`);
            markers.push(m);
            map.setView([geo.latitude, geo.longitude], 6);
        } else {
            appendLog("[INFO] Geo lookup returned no coords for " + ip);
        }
    } catch(e) {
        appendLog("[WARN] Geo lookup failed");
    }
}

// ---- Live hacker code animation (right panel) ----
const codeLines = [
    "auth > OK", "payload > queued", "trace > started", "indexing logs",
    "contacting 3 nodes", "decrypting headers", "recon complete", "monitoring inbound"
];
function startCodeAnimation() {
    const box = document.getElementById("codeBox");
    setInterval(() => {
        const line = document.createElement("div");
        line.className = "code-line";
        line.textContent = codeLines[Math.floor(Math.random()*codeLines.length)] + " â€” " + (Math.random().toString(36).slice(2,10));
        box.appendChild(line);
        box.scrollTop = box.scrollHeight;
    }, 220);
}

// ---- Live log feed ----
function appendLog(text) {
    const feed = document.getElementById("logFeed");
    const line = document.createElement("div");
    line.className = "log-line";
    line.textContent = text;
    feed.appendChild(line);
    feed.scrollTop = feed.scrollHeight;
}

// ---- modal handlers ----
function openModal() { document.getElementById("modal").style.display = "block"; }
function closeModal() { document.getElementById("modal").style.display = "none"; }

// ---- theme toggle ----
function toggleTheme() {
    document.body.classList.toggle("alt-theme");
}

// ---- export PDF via jsPDF ----
async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const details = document.getElementById("details").innerText;
    doc.setFontSize(12);
    doc.text("PROJECT KRS - Order Report", 10, 10);
    doc.text(details, 10, 20);
    // add selfie if available
    const img = document.getElementById("modalImg").src;
    if (img) {
        try {
            const blob = await fetch(img).then(r=>r.blob());
            const reader = new FileReader();
            reader.onload = function() {
                doc.addImage(reader.result, 'PNG', 10, 80, 60, 60);
                doc.save('order_report.pdf');
            };
            reader.readAsDataURL(blob);
        } catch(e) {
            doc.save('order_report.pdf');
        }
    } else {
        doc.save('order_report.pdf');
    }
}

// ---- simple escape helper ----
function escapeHtml(s) {
    if (!s) return "";
    return s.replace(/[&<>"'`=\/]/g, function(ch) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[ch];
    });
}
</script>

</body>
</html>
